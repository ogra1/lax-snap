#!/bin/sh -e

mkdir -p $SNAP_DATA/fontconfig

echo "<fontconfig>" > ${SNAP_DATA}/fontconfig/fonts.conf
echo "<cachedir>${SNAP_DATA}/fontconfig</cachedir>" >> ${SNAP_DATA}/fontconfig/fonts.conf
echo "<include ignore_missing=\"yes\">/etc/fonts/fonts.conf</include>" >> ${SNAP_DATA}/fontconfig/fonts.conf
if [ ! -z $SNAP_DESKTOP_RUNTIME ]; then
echo "<include ignore_missing=\"yes\">${SNAP_DESKTOP_RUNTIME}/etc/fonts/fonts.conf</include>" >> ${SNAP_DATA}/fontconfig/fonts.conf
fi
echo "</fontconfig>" >> ${SNAP_DATA}/fontconfig/fonts.conf

export FONTCONFIG_FILE=${SNAP_DATA}/fontconfig/fonts.conf

FC_CACHE_BIN="${SNAP}/usr/bin/fc-cache"

if [ ! -z $SNAP_DESKTOP_RUNTIME ]; then
  ARCH="$(arch)"
  case $ARCH in
    x86_64)
      TRIPLET="x86_64-linux-gnu"
    ;;
    armv7l)
      TRIPLET="arm-linux-gnueabihf"
    ;;
    aarch64)
      TRIPLET="aarch64-linux-gnu"
    ;;
  esac
  export LD_LIBRARY_PATH="/lib:/lib/${TRIPLET}:/usr/lib:/usr/lib/${TRIPLET}:${SNAP}/lib:${SNAP}/usr/lib:${SNAP}/lib/${TRIPLET}:${SNAP}/usr/lib/${TRIPLET}:${SNAP_DESKTOP_RUNTIME}/usr/lib/${TRIPLET}:${SNAP_DESKTOP_RUNTIME}/usr/lib:${SNAP_DESKTOP_RUNTIME}/lib:${SNAP_DESKTOP_RUNTIME}/lib/${TRIPLET}"
  FC_CACHE_BIN="${SNAP_DESKTOP_RUNTIME}/usr/bin/fc-cache"
fi

exec ${SNAP}/snap/command-chain/snapcraft-runner ${FC_CACHE_BIN} --force --system-only --verbose
